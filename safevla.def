Bootstrap: docker
From: nvidia/cuda:12.1.0-runtime-ubuntu22.04
Stage: build


%files
    container_configs/10_nvidia.json /usr/share/glvnd/egl_vendor.d/10_nvidia.json
    container_configs/nvidia_layers.json /etc/vulkan/implicit_layer.d/nvidia_layers.json
    container_configs/nvidia_icd.json /etc/vulkan/icd.d/nvidia_icd.json
    requirements.txt /requirements.txt
    scripts/install.sh /install.sh
%post
    export DEBIAN_FRONTEND=noninteractive
    apt-get update && apt-get install libgl1 git wget libvulkan1 vulkan-tools ca-certificates -y
    apt-get install tzdata
    apt-get install -y hdf5-tools
    apt-get install -y screen
    apt-get install -y telnet
    apt-get install -y swig
    apt-get install -y libglib2.0-0
    apt-get install -y python3 python3-pip
    python3 -m pip install --upgrade pip wheel setuptools
    python3 -m pip install torch==2.4.1+cu121 torchvision==0.19.1+cu121 torchaudio==2.4.1+cu121 --extra-index-url https://download.pytorch.org/whl/cu121
    bash /install.sh
    python3 -m pip install --no-deps "git+https://github.com/allenai/allenact.git@d055fc9d4533f086e0340fe0a838ed42c28d932e#egg=allenact_plugins[all]&subdirectory=allenact_plugins"
    python3 -m pip install --no-deps "git+https://github.com/rdesc/allenact.git@main#egg=allenact&subdirectory=allenact"
    python3 -m pip install --no-deps --extra-index-url https://ai2thor-pypi.allenai.org ai2thor==0+966bd7758586e05d18f6181f459c0e90ba318bec
    python3 -m pip install remote_pdb

%test
    grep -q NAME=\"Ubuntu\" /etc/os-release
    if [ $? -eq 0 ]; then
        echo "Container base is Ubuntu as expected."
    else
        echo "Container base is not Ubuntu."
        exit 1
    fi

%labels
    Author sacha
    Version v0.0.1

%help
    Container to run AI2-THOR on the Mila cluster.
